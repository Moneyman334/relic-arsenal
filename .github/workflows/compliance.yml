name: Compliance Guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  secrets-scan:
    name: ğŸ”’ Secrets Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Truffelhog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  license-verification:
    name: ğŸ›¡ï¸ License Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Node.js licenses
        run: |
          echo "ğŸ” Scanning Node.js dependencies for license compliance..."
          npx license-checker --summary --onlyAllow "MIT;Apache-2.0;BSD;ISC;CC0-1.0;Unlicense;WTFPL" --excludePrivatePackages || {
            echo "âŒ License check failed - unauthorized licenses detected"
            echo "ğŸ“‹ Generating detailed license report..."
            npx license-checker --detailed
            exit 1
          }

      - name: Generate license report
        run: |
          echo "ğŸ“„ Generating license compliance report..."
          npx license-checker --csv --out license-report.csv
          npx license-checker --summary

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-compliance-report
          path: license-report.csv

      - name: Check for Python dependencies (if any)
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "Pipfile" ]; then
            echo "ğŸ Python dependencies detected"
            if command -v pip &> /dev/null; then
              echo "Installing pip-licenses..."
              pip install pip-licenses
              echo "ğŸ” Scanning Python dependencies..."
              pip-licenses --format=table --with-license-file
            else
              echo "âš ï¸ pip not found, skipping Python license check"
            fi
          else
            echo "â„¹ï¸ No Python dependencies found"
          fi

  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=moderate || {
            echo "âŒ Security vulnerabilities detected"
            echo "ğŸ“‹ Generating detailed audit report..."
            npm audit --json > security-audit.json || true
            exit 1
          }

      - name: Upload security audit
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: security-audit-report
          path: security-audit.json

  compliance-summary:
    name: ğŸ“‹ Compliance Summary
    runs-on: ubuntu-latest
    needs: [secrets-scan, license-verification, security-audit]
    if: always()
    steps:
      - name: Compliance Status
        run: |
          echo "ğŸ”® Compliance Guard Ritual Complete"
          echo "âš¡ Secrets Scan: ${{ needs.secrets-scan.result }}"
          echo "ğŸ›¡ï¸ License Check: ${{ needs.license-verification.result }}"
          echo "ğŸ”’ Security Audit: ${{ needs.security-audit.result }}"
          
          if [[ "${{ needs.secrets-scan.result }}" == "success" && 
                "${{ needs.license-verification.result }}" == "success" && 
                "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "âœ… All compliance checks passed - Vault secured"
          else
            echo "âŒ Compliance violations detected - Vault breach risk"
            exit 1
          fi